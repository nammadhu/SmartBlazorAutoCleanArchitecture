@page "/cardtypes"
@using SHARED.Features.CardTypes.Commands
@inject ICardTypeController CardTypeService
@inject AuthenticationStateProvider AuthProvider

<h3>Card Types</h3>

<FluentDataGrid Items="@paginatedCardTypes.AsQueryable()" TGridItem="CardTypeDto" SelectionMode="Single" Style="height: auto; max-width: 100%;">
    <PropertyColumn Property="@(c => c.Id)" Title="ID" Sortable="true" />
    <PropertyColumn Property="@(c => c.Name)" Title="Name" Sortable="true" />
    <PropertyColumn Property="@(c => c.IconColor)" Title="Icon Color" Sortable="true" />
    <PropertyColumn Property="@(c => c.Price)" Title="Price" Sortable="true" />
    <TemplateColumn Title="Actions">
        <div>
            <FluentButton Title="Edit" IconEnd=@(new Icons.Regular.Size24.Edit()) OnClick="() => OpenUpdateDialog(context)" Disabled="@(!CanEdit)" />
            <FluentButton Title="Delete" IconEnd=@(new Icons.Regular.Size24.Delete()) OnClick="() => OpenDeleteDialog(context)" Disabled="@(!CanDelete)" />
        </div>
    </TemplateColumn>
</FluentDataGrid>

<div class="pagination-container">
    <FluentButton Title="Previous" IconEnd=@(new Icons.Regular.Size24.Previous()) OnClick="GoToPreviousPage" Disabled="@isFirstPage" />
    <span>Page @currentPage of @totalPages</span>
    <FluentButton Title="Next" IconEnd=@(new Icons.Regular.Size24.Next()) OnClick="GoToNextPage" Disabled="@isLastPage" />
</div>

@if (CanCreate)
    {
    <FluentButton Title="Create New" OnClick="@CreateNew" Style="margin-top: 10px;" />
    }

<style>
    @@media (max-width: 600px) {
        fluent-data-grid {
            width: 100%;
            font-size: 14px;
        }

        fluent-button {
            font-size: 12px;
            margin: 5px 0;
        }

        .pagination-container {
            text-align: center;
            margin-top: 10px;
        }

            .pagination-container span {
                margin: 0 10px;
            }
    }
</style>

@code {
    private List<CardTypeDto> cardTypes = new();
    private List<CardTypeDto> paginatedCardTypes => cardTypes
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    private int currentPage = 1;
    private int pageSize = 3; // Items per page
    private int totalPages => (int)Math.Ceiling(cardTypes.Count / (double)pageSize);
    private bool isFirstPage => currentPage == 1;
    private bool isLastPage => currentPage == totalPages;

    private bool CanEdit => RolePermissions.CanEdit(GetUserRole());
    private bool CanCreate => RolePermissions.CanCreate(GetUserRole());
    private bool CanDelete => RolePermissions.CanDelete(GetUserRole());

    protected override async Task OnInitializedAsync()
        {
        await LoadCardTypesAsync();
        }

    private async Task LoadCardTypesAsync()
        {
        var result = await CardTypeService.GetAll();
        if (result?.Success == true && result?.Data != null)
            {
            cardTypes = result.Data;
            }
        else cardTypes = [];
        }




    //private CardTypeDto? SelectedDto { get; set; }

    private async Task CreateNew() => await OpenUpdateDialog(new CardTypeDto());
    private async Task OpenUpdateDialog(CardTypeDto cardType)
        {
        var dialog = await DialogServices.ShowDialogAsync<CreateUpdateCardTypeDialog>(cardType, new DialogParameters()
                {
                Height = "240px",
                Title = cardType.Id > 0 ? "Creating New" : $"Updating the {cardType.Name}",
                PreventDismissOnOverlayClick = true,
                PreventScroll = true,
                });

        var result = await dialog.Result;
        if (!result.Cancelled && result.Data != null)
            {
            cardType = (CardTypeDto)result.Data;
            await LoadCardTypesAsync();
            }
        }



    private void OpenDeleteDialog(CardTypeDto cardType)
        {
        //add dialog to confirm for deletion then  call DeleteCardType(CardTypeDto cardType)
        }

        //move below inside dialog 
    // private async Task DeleteCardType(CardTypeDto cardType)
    //     {
    //     await CardTypeService.Delete(cardType.Id);
    //     await LoadCardTypesAsync();
    //     }





    private void GoToPreviousPage() => currentPage -= (currentPage > 1 ? 1 : 0);

    private void GoToNextPage() => currentPage += (currentPage < totalPages ? 1 : 0);

    private string GetUserRole()
        {
        var authState = AuthProvider.GetAuthenticationStateAsync().Result;
        var user = authState.User;
        if (user?.Identity?.IsAuthenticated == true)
            return user.IsInRole("Admin") ? "Admin" : "Editor";
        else return null;
        }

    public static class RolePermissions
        {
        public static bool CanEdit(string role) => role == "Admin" || role == "Editor";
        public static bool CanCreate(string role) => role == "Admin";
        public static bool CanDelete(string role) => role == "Admin";
        }
}
